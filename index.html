<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qç‰ˆ Longcat: 100é—œå¤§æŒ‘æˆ°</title>
    <style>
        body {
            display: flex; flex-direction: column; align-items: center;
            background-color: #f7f1e3; font-family: 'Microsoft JhengHei', sans-serif;
            transition: background-color 0.8s ease; margin: 0; padding: 20px;
        }
        .ui-panel {
            background: white; padding: 15px 30px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px;
        }
        #game-container { position: relative; }
        canvas {
            background-color: #fff; border: 10px solid #fff;
            border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .stats { font-size: 18px; font-weight: bold; color: #333; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button {
            padding: 10px 20px; border: none; border-radius: 12px;
            background: #33d9b2; color: white; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #218c74; }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="login-modal" class="login-overlay">
    <div class="ui-panel">
        <h2>ğŸ± é•·é•·è²“å†’éšª ğŸ±</h2>
        <p>è¼¸å…¥åå­—é–‹å§‹ 100 é—œæŒ‘æˆ°ï¼š</p>
        <input type="text" id="username-input" placeholder="ä½ çš„åå­—..." style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
        <br><br>
        <button onclick="userLogin()">é€²å…¥éŠæˆ²</button>
    </div>
</div>

<div class="ui-panel">
    <h1><span id="display-name">Player</span> çš„å†’éšª</h1>
    <div class="stats">é—œå¡: <span id="lvl-num">1</span> / 100</div>
    <div id="skin-tag" style="color: #777;">è§£é–çš®è†šï¼šğŸ± æ©˜æ©˜</div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="btn-group">
    <button onclick="resetLevel()">é‡ç©æœ¬é—œ (åŒä¸€åœ°åœ–)</button>
    <button onclick="logout()" style="background:#aaa;">æ›´æ›å¸³è™Ÿ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let currentUser = "";
    let currentLvl = 1;
    let grid = [];
    let catPath = [];
    let skin = "ğŸ±";
    const TILE_SIZE = 55;

    const THEMES = [
        { bg: "#f7f1e3", wall: "ğŸ“¦" }, // è‰åŸ
        { bg: "#d1ccc0", wall: "ğŸ§±" }, // å·¥å» 
        { bg: "#ffb8b8", wall: "ğŸŒ¸" }, // æ«»èŠ±
        { bg: "#706fd3", wall: "ğŸ’" }  // åŸå ¡
    ];

    // --- æ ¸å¿ƒï¼šå›ºå®šç¨®å­çš„éš¨æ©Ÿç”Ÿæˆå™¨ ---
    // ç¢ºä¿ç¬¬ N é—œçš„åœ°åœ–æ°¸é ä¸€æ¨£
    function seededRandom(seed) {
        let x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }

    function generateFixedLevel(lvl) {
        const size = Math.min(4 + Math.floor(lvl / 10), 10); // æ¯10é—œå¢åŠ å¤§å°
        let newMap = Array.from({ length: size }, () => Array(size).fill(0));
        
        // ä½¿ç”¨é—œå¡æ•¸å­—ä½œç‚ºç¨®å­ä¾†æ”¾ç½®ç‰†å£
        const wallCount = Math.floor(size * size * 0.12);
        for(let i=0; i<wallCount; i++) {
            let rx = Math.floor(seededRandom(lvl + i) * size);
            let ry = Math.floor(seededRandom(lvl * i + 1) * size);
            if (!(rx === 0 && ry === 0)) newMap[ry][rx] = 1;
        }

        // èµ·é»å›ºå®šåœ¨ (0,0) æˆ–æ ¹æ“šç¨®å­å›ºå®šä½ç½®
        newMap[0][0] = 2; 
        return newMap;
    }

    function userLogin() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        currentUser = name;
        const savedData = JSON.parse(localStorage.getItem('longcat_100_data_' + name)) || { lvl: 1 };
        currentLvl = savedData.lvl;
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('display-name').innerText = name;
        initLevel();
    }

    function initLevel() {
        // æ ¸å¿ƒä¿®æ­£ï¼šå›ºå®šç²å–ç•¶å‰é—œå¡çš„åœ°åœ–
        const mapData = generateFixedLevel(currentLvl);
        grid = mapData.map(row => [...row]);
        
        // æ ¸å¿ƒä¿®æ­£ï¼šåˆå§‹åŒ–è·¯å¾‘æ™‚ç›´æ¥æ¨™è¨˜èµ·é»ç‚ºã€Œå·²å¡«æ»¿(3)ã€
        catPath = [{x: 0, y: 0}];
        grid[0][0] = 3; 

        // ä¸»é¡Œåˆ‡æ›
        const themeIndex = Math.floor((currentLvl-1) / 5) % THEMES.length;
        document.body.style.backgroundColor = THEMES[themeIndex].bg;
        
        // çš®è†šé€²åº¦
        if(currentLvl < 10) { skin = "ğŸ±"; }
        else if(currentLvl < 25) { skin = "ğŸ¦Š"; }
        else if(currentLvl < 50) { skin = "ğŸ¯"; }
        else { skin = "ğŸ²"; }
        
        document.getElementById('lvl-num').innerText = currentLvl;
        canvas.width = grid[0].length * TILE_SIZE;
        canvas.height = grid.length * TILE_SIZE;
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const theme = THEMES[Math.floor((currentLvl-1) / 5) % THEMES.length];

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                ctx.strokeStyle = "rgba(0,0,0,0.05)";
                ctx.strokeRect(c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                if(grid[r][c] === 1) {
                    ctx.font = "35px Arial";
                    ctx.fillText(theme.wall, c*TILE_SIZE + 10, r*TILE_SIZE + 42);
                }
            }
        }

        // ç•«æ‰€æœ‰ä½ç½®çš„è…³å° (åŒ…å«èµ·é»)
        catPath.forEach((pos, i) => {
            // ç¾åœ¨èµ·é»ä¹Ÿæœƒç•«ä¸Šè…³å°ï¼Œé™¤éå®ƒæ˜¯é ­éƒ¨
            if(i < catPath.length - 1) {
                ctx.font = "25px Arial";
                ctx.fillText("ğŸ¾", pos.x*TILE_SIZE + 15, pos.y*TILE_SIZE + 38);
            }
        });

        // ç•«é ­éƒ¨
        const head = catPath[catPath.length-1];
        ctx.font = "40px Arial";
        ctx.fillText(skin, head.x*TILE_SIZE + 8, head.y*TILE_SIZE + 45);
    }

    function move(dx, dy) {
        let head = catPath[catPath.length-1];
        let moved = false;
        while(true) {
            let nX = head.x + dx, nY = head.y + dy;
            if(nY>=0 && nY<grid.length && nX>=0 && nX<grid[0].length && grid[nY][nX] === 0) {
                grid[nY][nX] = 3;
                catPath.push({x: nX, y: nY});
                head = {x: nX, y: nY};
                moved = true;
            } else { break; }
        }
        if(moved) { draw(); checkWin(); }
    }

    function checkWin() {
        // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ 0 (ç©ºæ ¼)
        const hasEmpty = grid.some(row => row.includes(0));
        if(!hasEmpty) {
            setTimeout(() => {
                if(currentLvl >= 100) {
                    alert("å‚³å¥‡ï¼ä½ å·²é€šé—œæ‰€æœ‰ 100 é—œï¼");
                } else {
                    alert("ç¬¬ " + currentLvl + " é—œå®Œæˆï¼");
                    currentLvl++;
                    localStorage.setItem('longcat_100_data_' + currentUser, JSON.stringify({ lvl: currentLvl }));
                    initLevel();
                }
            }, 200);
        }
    }

    function resetLevel() { initLevel(); } // ç¾åœ¨é‡ç©æœƒè¼‰å…¥åŒä¸€å¼µå›ºå®šåœ°åœ–
    function logout() { location.reload(); }

    window.addEventListener('keydown', (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
        if(e.key === "ArrowUp") move(0, -1);
        if(e.key === "ArrowDown") move(0, 1);
        if(e.key === "ArrowLeft") move(-1, 0);
        if(e.key === "ArrowRight") move(1, 0);
    });
</script>

</body>
</html>
