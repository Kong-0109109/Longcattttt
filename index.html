<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Longcat Ultimate Edition</title>

<style>
body{
display:flex;
flex-direction:column;
align-items:center;
background:#f7f1e3;
font-family:"Microsoft JhengHei";
margin:0;padding:20px;
}
.ui{background:#fff;padding:15px 25px;border-radius:15px;
box-shadow:0 6px 12px rgba(0,0,0,.1);margin-bottom:15px}
canvas{
background:#fff;border-radius:15px;
box-shadow:0 0 20px rgba(0,0,0,.15)}
button{
padding:10px 20px;border:none;border-radius:10px;
background:#ff7675;color:#fff;font-weight:bold;cursor:pointer}
</style>
</head>

<body>

<div class="ui">
<h2 id="player">Player</h2>
ÈóúÂç° <span id="lvl">1</span>/20„ÄÄ
(Z ÂèØÂæ©Âéü‰∏ÄÊ≠•)
</div>

<canvas id="game"></canvas>

<div style="margin-top:10px">
<button onclick="reset()">ÈáçÁé©</button>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let grid=[],catPath=[],history=[];
let lvl=1,TILE=60;

//////////////////////////////////////////////////
// ‚≠ê ÈáçË®≠ÂæåÁöÑÈóúÂç°ÔºàÈáçÊñ∞Âπ≥Ë°°Ôºâ
//////////////////////////////////////////////////

const LEVELS=[
{m:[[2,0],[1,0]]},
{m:[[2,0,0],[0,1,0],[0,0,0]]},
{m:[[0,0,2],[1,1,0],[0,0,0]]},
{m:[[0,0,0,0],[0,1,1,0],[0,0,2,0],[0,0,0,0]]},
{m:[[2,0,1,1],[0,0,0,1],[1,1,0,0],[1,1,1,0]]},

{m:[[0,0,1,0],[0,2,0,0],[0,1,1,0],[0,0,0,0]]},
{m:[[0,0,0,0],[1,1,1,0],[2,0,0,0],[0,1,1,1]]},
{m:[[0,1,0,0],[0,0,0,1],[1,0,2,0],[0,0,1,0]]},
{m:[[2,0,0,0,0],[1,1,1,1,0],[0,0,0,0,0],[0,1,1,1,1]]},
{m:[[0,0,1,0,0],[0,2,0,0,0],[1,0,1,0,1],[0,0,0,0,0]]},

{m:[[1,0,0,0,1],[0,0,2,0,0],[0,1,1,1,0],[0,0,0,0,0]]},
{m:[[2,0,0,0,0,0],[1,1,1,1,1,0],[0,0,0,0,0,0],[0,1,1,1,1,1]]},
{m:[[0,1,0,0,0],[0,0,0,1,0],[1,0,2,0,0],[0,0,1,0,1]]},
{m:[[1,0,0,0,0],[0,2,1,1,0],[0,0,0,1,0],[1,1,0,0,0]]},
{m:[[0,0,0,0,0,0],[0,1,1,1,1,0],[2,0,0,0,1,0],[0,1,1,0,0,0]]},

{m:[[1,0,0,0,0,1],[0,1,1,1,1,0],[0,1,2,0,1,0],[0,1,0,0,1,0]]},
{m:[[2,0,1,0,1,0],[0,0,0,0,0,0],[1,1,1,1,1,0]]},
{m:[[0,0,0,1,0,0],[0,1,0,0,0,1],[0,0,2,1,0,0],[1,0,0,0,0,0]]},
{m:[[0,1,1,1,1],[0,0,0,1,0],[1,1,2,1,0],[0,0,0,0,0]]},
{m:[[2,0,0,0,0,0,0],[0,1,1,1,1,1,0],[0,0,0,0,0,0,0],[1,1,1,1,1,1,0]]}
];

//////////////////////////////////////////////////
// ÂàùÂßãÂåñ
//////////////////////////////////////////////////

function init(){
grid=LEVELS[lvl-1].m.map(r=>[...r]);
catPath=[];history=[];

for(let y=0;y<grid.length;y++)
for(let x=0;x<grid[0].length;x++)
if(grid[y][x]==2){
catPath.push({x,y});
grid[y][x]=3;
}

TILE=Math.min(70,500/grid.length);
canvas.width=grid[0].length*TILE;
canvas.height=grid.length*TILE;

document.getElementById("lvl").innerText=lvl;
draw();
}

//////////////////////////////////////////////////
// Flood Fill Ê™¢Êü•Ê≠ªÂ±ÄÔºàÊ†∏ÂøÉÊîπËâØÔºâ
//////////////////////////////////////////////////

function reachableCount(start){
let stack=[start];
let visited=new Set([start.x+","+start.y]);
let count=0;

while(stack.length){
let p=stack.pop();
count++;

[[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
let nx=p.x+d[0],ny=p.y+d[1];
let key=nx+","+ny;
if(grid[ny]?.[nx]===0&&!visited.has(key)){
visited.add(key);
stack.push({x:nx,y:ny});
}
});
}
return count;
}

//////////////////////////////////////////////////
// ÁßªÂãï
//////////////////////////////////////////////////

function move(dx,dy){

saveHistory();

let head=catPath.at(-1);

while(true){
let nx=head.x+dx;
let ny=head.y+dy;

if(grid[ny]?.[nx]!==0)break;

grid[ny][nx]=3;
catPath.push({x:nx,y:ny});
head={x:nx,y:ny};

if(!isSafe()) {
undo();
return;
}
}

draw();
checkWin();
}

function isSafe(){
let empty=[];
for(let y=0;y<grid.length;y++)
for(let x=0;x<grid[0].length;x++)
if(grid[y][x]==0) empty.push({x,y});

if(!empty.length) return true;

return reachableCount(empty[0])===empty.length;
}

//////////////////////////////////////////////////
// Undo
//////////////////////////////////////////////////

function saveHistory(){
history.push({
grid:grid.map(r=>[...r]),
path:catPath.map(p=>({...p}))
});
}

function undo(){
let h=history.pop();
if(!h)return;
grid=h.grid;
catPath=h.path;
draw();
}

//////////////////////////////////////////////////
// Áï´Èù¢
//////////////////////////////////////////////////

function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);

grid.forEach((row,y)=>{
row.forEach((cell,x)=>{
ctx.strokeStyle="#eee";
ctx.strokeRect(x*TILE,y*TILE,TILE,TILE);

if(cell==1){
ctx.font=(TILE*.7)+"px Arial";
ctx.fillText("üì¶",x*TILE+10,y*TILE+TILE*.8);
}
});
});

catPath.forEach((p,i)=>{
ctx.font=(TILE*.45)+"px Arial";
if(i<catPath.length-1)
ctx.fillText("üêæ",p.x*TILE+15,p.y*TILE+TILE*.7);
});

let head=catPath.at(-1);
ctx.font=(TILE*.8)+"px Arial";
ctx.fillText("üê±",head.x*TILE+5,head.y*TILE+TILE*.85);
}

//////////////////////////////////////////////////
// ÂãùÂà©
//////////////////////////////////////////////////

function checkWin(){
if(grid.some(r=>r.includes(0)))return;

setTimeout(()=>{
lvl++;
if(lvl>20){
alert("üéâ Longcat ÂÆåÂÖ®Âà∂Èú∏ÔºÅ");
lvl=1;
}
init();
},250);
}

//////////////////////////////////////////////////
// ÊéßÂà∂
//////////////////////////////////////////////////

window.addEventListener("keydown",e=>{
if(e.key==="z"||e.key==="Z") undo();
if(e.key==="ArrowUp")move(0,-1);
if(e.key==="ArrowDown")move(0,1);
if(e.key==="ArrowLeft")move(-1,0);
if(e.key==="ArrowRight")move(1,0);
});

function reset(){init();}

init();
</script>
</body>
</html>
