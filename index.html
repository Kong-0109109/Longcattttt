<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longcat 100é—œç²¾é¸æŒ‘æˆ°</title>
    <style>
        body {
            display: flex; flex-direction: column; align-items: center;
            background-color: #f7f1e3; font-family: 'Microsoft JhengHei', sans-serif;
            margin: 0; padding: 20px; min-height: 100vh;
        }
        #loading-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #ffeaa7; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200;
        }
        .ui-panel {
            background: white; padding: 15px 30px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px;
        }
        canvas {
            background-color: #fff; border: 8px solid #fff;
            border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            max-width: 90vw;
        }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center;
            align-items: center; z-index: 100;
        }
        button {
            padding: 10px 25px; border: none; border-radius: 12px;
            background: #ff7675; color: white; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <h2>ğŸ± æ­£åœ¨æº–å‚™ 100 å€‹é—œå¡...</h2>
    <p>é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
</div>

<div id="login-modal" class="login-overlay">
    <div class="ui-panel">
        <h2>ğŸ± Longcat å†’éšª ğŸ±</h2>
        <input type="text" id="username-input" placeholder="ä½ çš„åå­—" style="padding: 10px; margin-bottom: 10px;">
        <br>
        <button onclick="userLogin()">é–‹å§‹æŒ‘æˆ°</button>
    </div>
</div>

<div class="ui-panel">
    <h1><span id="display-name">Player</span></h1>
    <div style="font-weight:bold;">é—œå¡: <span id="lvl-num">1</span> / 100</div>
</div>

<canvas id="gameCanvas"></canvas>

<div style="margin-top:15px; display:flex; gap:10px;">
    <button onclick="resetLevel()">é‡ç©æœ¬é—œ</button>
    <button onclick="logout()" style="background:#aaa;">æ›´æ›å¸³è™Ÿ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let currentUser = "";
    let currentLvl = 1;
    let grid = [];
    let catPath = [];
    let ALL_LEVELS = [];
    let TILE_SIZE = 50;

    // 1. æ·±åº¦å„ªå…ˆæœç´¢ç”Ÿæˆåœ°åœ– (å¢åŠ é˜²å¡æ­»é™åˆ¶)
    function createMap(lvl) {
        const size = Math.min(4 + Math.floor(lvl / 15), 9);
        let map, path;
        let success = false;
        let retry = 0;

        while(!success && retry < 20) {
            map = Array.from({ length: size }, () => Array(size).fill(1));
            path = [];
            let cx = Math.floor(Math.random() * size), cy = Math.floor(Math.random() * size);
            map[cy][cx] = 0;
            path.push({x: cx, y: cy});

            const target = Math.floor(size * size * 0.75);
            for(let i=0; i<1000; i++) {
                let last = path[path.length-1];
                let dirs = [[0,1],[0,-1],[1,0],[-1,0]].sort(()=>Math.random()-0.5);
                let move = false;
                for(let d of dirs) {
                    let nx = last.x + d[0], ny = last.y + d[1];
                    if(nx>=0 && nx<size && ny>=0 && ny<size && map[ny][nx]===1) {
                        map[ny][nx] = 0;
                        path.push({x: nx, y: ny});
                        move = true; break;
                    }
                }
                if(!move || path.length >= target) break;
            }
            if(path.length >= target * 0.8) success = true;
            retry++;
        }
        map[path[0].y][path[0].x] = 2; // èµ·é»
        return { map, theme: getTheme(lvl) };
    }

    function getTheme(lvl) {
        const themes = [
            { bg: "#f7f1e3", wall: "ğŸ“¦", skin: "ğŸ±" },
            { bg: "#d1ccc0", wall: "ğŸ§±", skin: "ğŸ±" },
            { bg: "#ffb8b8", wall: "ğŸŒ¸", skin: "ğŸ¦Š" },
            { bg: "#706fd3", wall: "ğŸ’", skin: "ğŸ²" }
        ];
        return themes[Math.floor((lvl-1)/25) % themes.length];
    }

    // 2. åˆå§‹åŒ–æµç¨‹
    window.onload = () => {
        // éåŒæ­¥ç”Ÿæˆï¼Œé˜²æ­¢ UI å¡æ­»
        setTimeout(() => {
            for(let i=1; i<=100; i++) ALL_LEVELS.push(createMap(i));
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
        }, 500);
    };

    function userLogin() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return;
        currentUser = name;
        const saved = JSON.parse(localStorage.getItem('lc_v6_'+name)) || {lvl:1};
        currentLvl = saved.lvl;
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('display-name').innerText = name;
        initLevel();
    }

    function initLevel() {
        const data = ALL_LEVELS[currentLvl-1];
        grid = data.map.map(r => [...r]);
        catPath = [];
        document.body.style.backgroundColor = data.theme.bg;

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                if(grid[r][c] === 2) {
                    catPath.push({x:c, y:r});
                    grid[r][c] = 3;
                }
            }
        }
        TILE_SIZE = Math.min(60, (window.innerHeight*0.5)/grid.length);
        canvas.width = grid[0].length * TILE_SIZE;
        canvas.height = grid.length * TILE_SIZE;
        document.getElementById('lvl-num').innerText = currentLvl;
        draw();
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const data = ALL_LEVELS[currentLvl-1];
        grid.forEach((row, r) => row.forEach((cell, c) => {
            ctx.strokeStyle = "#eee";
            ctx.strokeRect(c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE, TILE_SIZE);
            if(cell === 1) {
                ctx.font = (TILE_SIZE*0.7)+"px Arial";
                ctx.fillText(data.theme.wall, c*TILE_SIZE+TILE_SIZE*0.15, r*TILE_SIZE+TILE_SIZE*0.75);
            }
        }));
        catPath.forEach((p, i) => {
            if(i < catPath.length-1) {
                ctx.font = (TILE_SIZE*0.5)+"px Arial";
                ctx.fillText("ğŸ¾", p.x*TILE_SIZE+TILE_SIZE*0.25, p.y*TILE_SIZE+TILE_SIZE*0.7);
            }
        });
        const head = catPath[catPath.length-1];
        ctx.font = (TILE_SIZE*0.8)+"px Arial";
        ctx.fillText(data.theme.skin, head.x*TILE_SIZE+TILE_SIZE*0.1, head.y*TILE_SIZE+TILE_SIZE*0.8);
    }

    function move(dx, dy) {
        let head = catPath[catPath.length-1], moved = false;
        while(true) {
            let nx = head.x+dx, ny = head.y+dy;
            if(ny>=0 && ny<grid.length && nx>=0 && nx<grid[0].length && grid[ny][nx]===0) {
                grid[ny][nx]=3; catPath.push({x:nx, y:ny}); head={x:nx, y:ny}; moved=true;
            } else break;
        }
        if(moved) { draw(); checkWin(); }
    }

    function checkWin() {
        if(!grid.some(r => r.includes(0))) {
            setTimeout(() => {
                currentLvl++;
                localStorage.setItem('lc_v6_'+currentUser, JSON.stringify({lvl:currentLvl}));
                initLevel();
            }, 200);
        }
    }

    function resetLevel() { initLevel(); }
    function logout() { location.reload(); }

    window.addEventListener('keydown', e => {
        if(e.key.includes("Arrow")) {
            e.preventDefault();
            if(e.key === "ArrowUp") move(0,-1);
            if(e.key === "ArrowDown") move(0,1);
            if(e.key === "ArrowLeft") move(-1,0);
            if(e.key === "ArrowRight") move(1,0);
        }
    });
</script>
</body>
</html>
