<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longcat 100é—œç²¾é¸æŒ‘æˆ°</title>
    <style>
        body {
            display: flex; flex-direction: column; align-items: center;
            background-color: #f7f1e3; font-family: 'Microsoft JhengHei', sans-serif;
            transition: background-color 0.8s ease; margin: 0; padding: 20px;
        }
        .ui-panel {
            background: white; padding: 15px 30px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px;
        }
        canvas {
            background-color: #fff; border: 8px solid #fff;
            border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .stats { font-size: 18px; font-weight: bold; color: #333; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button {
            padding: 10px 25px; border: none; border-radius: 12px;
            background: #ff7675; color: white; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #d63031; }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="login-modal" class="login-overlay">
    <div class="ui-panel">
        <h2>ğŸ± Longcat 100 ğŸ±</h2>
        <input type="text" id="username-input" placeholder="ä½ çš„å†’éšªè€…åå­—" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
        <br><br>
        <button onclick="userLogin()">é–‹å§‹æŒ‘æˆ° 100 é—œ</button>
    </div>
</div>

<div class="ui-panel">
    <h1><span id="display-name">Player</span></h1>
    <div class="stats">Level: <span id="lvl-num">1</span> / 100</div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="btn-group">
    <button onclick="resetLevel()">é‡ç©æœ¬é—œ</button>
    <button onclick="logout()" style="background:#aaa;">æ›´æ›å¸³è™Ÿ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let currentUser = "";
    let currentLvl = 1;
    let grid = [];
    let catPath = [];
    let TILE_SIZE = 60;
    const TOTAL_LEVELS = 100;

    // å„²å­˜æ‰€æœ‰ç”Ÿæˆçš„ 100 é—œæ•¸æ“š
    const ALL_LEVELS = [];

    // --- é—œå¡ç”Ÿæˆæ ¸å¿ƒï¼šé€†å‘æŒ–æ˜æ³• (ç¢ºä¿æœ‰è§£) ---
    function generate100Levels() {
        for (let i = 1; i <= TOTAL_LEVELS; i++) {
            const size = Math.min(4 + Math.floor(i / 15), 10); // éš¨é›£åº¦å¢åŠ åœ°åœ–å¤§å°
            let map = Array.from({ length: size }, () => Array(size).fill(1)); // å…ˆå…¨æ˜¯ç‰†å£
            
            // å¾éš¨æ©Ÿä¸€é»é–‹å§‹é€†å‘æŒ–æ˜
            let curX = Math.floor(Math.random() * size);
            let curY = Math.floor(Math.random() * size);
            map[curY][curX] = 2; // é€™è£¡æ˜¯ç©å®¶æœ€å¾Œè¦é”åˆ°çš„ã€Œçµ‚é»ã€ï¼Œä½†åœ¨é€™ç®—æ³•ä¸­æ˜¯ã€Œèµ·é»ã€
            
            let steps = 0;
            const maxSteps = size * size - Math.floor(size/2); // æŒ–æ˜æ­¥æ•¸
            const dirs = [[0,1],[0,-1],[1,0],[-1,0]];

            while(steps < maxSteps) {
                let d = dirs[Math.floor(Math.random()*4)];
                let nX = curX + d[0], nY = curY + d[1];
                if(nX>=0 && nX<size && nY>=0 && nY<size) {
                    if(map[nY][nX] === 1) {
                        map[nY][nX] = 0;
                        steps++;
                    }
                    curX = nX; curY = nY;
                }
            }
            // ä¿®æ­£ï¼šæœ€å¾Œåœç•™çš„ä½ç½®å°±æ˜¯ç©å®¶çš„èµ·å§‹é»
            map[curY][curX] = 2; 

            // è¨­å®šä¸»é¡Œ
            const themes = [
                { bg: "#f7f1e3", wall: "ğŸ“¦", skin: "ğŸ±" },
                { bg: "#d1ccc0", wall: "ğŸ§±", skin: "ğŸ±" },
                { bg: "#ffb8b8", wall: "ğŸŒ¸", skin: "ğŸ¦Š" },
                { bg: "#706fd3", wall: "ğŸ’", skin: "ğŸ²" }
            ];
            
            ALL_LEVELS.push({
                map: map,
                theme: themes[Math.floor((i-1)/25) % themes.length]
            });
        }
    }

    function userLogin() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        currentUser = name;
        const savedData = JSON.parse(localStorage.getItem('longcat_final_v4_' + name)) || { lvl: 1 };
        currentLvl = savedData.lvl;
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('display-name').innerText = name + " çš„å†’éšª";
        initLevel();
    }

    function initLevel() {
        const data = ALL_LEVELS[currentLvl - 1];
        grid = data.map.map(row => [...row]);
        catPath = [];

        document.body.style.backgroundColor = data.theme.bg;

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                if(grid[r][c] === 2) {
                    catPath.push({x: c, y: r});
                    grid[r][c] = 3; // æ¨™è¨˜ç‚ºè²“èº«é«”
                }
            }
        }

        // å‹•æ…‹èª¿æ•´æ ¼å­å¤§å°é¿å…è¶…å‡ºè¢å¹•
        TILE_SIZE = Math.min(60, (window.innerHeight * 0.5) / grid.length);
        canvas.width = grid[0].length * TILE_SIZE;
        canvas.height = grid.length * TILE_SIZE;
        document.getElementById('lvl-num').innerText = currentLvl;
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const data = ALL_LEVELS[currentLvl - 1];

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                ctx.strokeStyle = "rgba(0,0,0,0.05)";
                ctx.strokeRect(c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                if(grid[r][c] === 1) {
                    ctx.font = (TILE_SIZE*0.7) + "px Arial";
                    ctx.fillText(data.theme.wall, c*TILE_SIZE + TILE_SIZE*0.15, r*TILE_SIZE + TILE_SIZE*0.75);
                }
            }
        }

        // ç•«è…³å°
        catPath.forEach((pos, i) => {
            if(i < catPath.length - 1) {
                ctx.font = (TILE_SIZE*0.5) + "px Arial";
                ctx.fillText("ğŸ¾", pos.x*TILE_SIZE + TILE_SIZE*0.25, pos.y*TILE_SIZE + TILE_SIZE*0.7);
            }
        });

        // ç•«é ­éƒ¨
        const head = catPath[catPath.length - 1];
        ctx.font = (TILE_SIZE*0.8) + "px Arial";
        ctx.fillText(data.theme.skin, head.x*TILE_SIZE + TILE_SIZE*0.1, head.y*TILE_SIZE + TILE_SIZE*0.8);
    }

    function move(dx, dy) {
        let head = catPath[catPath.length - 1];
        let moved = false;
        while(true) {
            let nX = head.x + dx, nY = head.y + dy;
            if(nY >= 0 && nY < grid.length && nX >= 0 && nX < grid[0].length && grid[nY][nX] === 0) {
                grid[nY][nX] = 3;
                catPath.push({x: nX, y: nY});
                head = {x: nX, y: nY};
                moved = true;
            } else { break; }
        }
        if(moved) { draw(); checkWin(); }
    }

    function checkWin() {
        const hasEmpty = grid.some(row => row.includes(0));
        if(!hasEmpty) {
            setTimeout(() => {
                if(currentLvl >= 100) {
                    alert("å‚³å¥‡ï¼ä½ å®Œæˆäº†å…¨éƒ¨ 100 é—œï¼");
                } else {
                    alert("é—œå¡å®Œæˆï¼");
                    currentLvl++;
                    localStorage.setItem('longcat_final_v4_' + currentUser, JSON.stringify({ lvl: currentLvl }));
                    initLevel();
                }
            }, 200);
        }
    }

    function resetLevel() { initLevel(); }
    function logout() { location.reload(); }

    window.addEventListener('keydown', (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
        if(e.key === "ArrowUp") move(0, -1);
        if(e.key === "ArrowDown") move(0, 1);
        if(e.key === "ArrowLeft") move(-1, 0);
        if(e.key === "ArrowRight") move(1, 0);
    });

    // åˆå§‹åŒ– 100 é—œæ•¸æ“š
    generate100Levels();
</script>

</body>
</html>
