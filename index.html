<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Longcat PRO Edition</title>

<style>
body{
margin:0;
background:#f7f1e3;
font-family:"Microsoft JhengHei";
display:flex;
flex-direction:column;
align-items:center;
}

canvas{
background:#fff;
margin-top:15px;
border-radius:14px;
box-shadow:0 10px 25px rgba(0,0,0,.15);
touch-action:none;
}

.panel{
background:#fff;
padding:12px 20px;
margin-top:15px;
border-radius:12px;
box-shadow:0 5px 10px rgba(0,0,0,.1);
}
</style>
</head>

<body>

<div class="panel">
ÈóúÂç° <span id="lvl">1</span>
ÔΩú
ÊòüÁ¥öÔºö<span id="stars">‚≠ê‚≠ê‚≠ê</span>
ÔΩú
ZÂæ©Âéü ÔΩú EÁ∑®ËºØÂô®
</div>

<canvas id="game"></canvas>

<script>
//////////////////////////////////////////////////
// Âü∫Êú¨Ë®≠ÂÆö
//////////////////////////////////////////////////

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let TILE=70;
let grid=[],catPath=[];
let level=1;
let history=[];
let moveCount=0;
let editorMode=false;

//////////////////////////////////////////////////
// Èü≥ÊïàÁ≥ªÁµ±
//////////////////////////////////////////////////

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();

function beep(freq,time){
let o=audioCtx.createOscillator();
let g=audioCtx.createGain();
o.connect(g); g.connect(audioCtx.destination);
o.frequency.value=freq;
o.start();
g.gain.exponentialRampToValueAtTime(.0001,audioCtx.currentTime+time);
o.stop(audioCtx.currentTime+time);
}

//////////////////////////////////////////////////
// ÈóúÂç°
//////////////////////////////////////////////////

const LEVELS=[
{best:4,m:[[2,0],[1,0]]},
{best:6,m:[[2,0,0],[0,1,0],[0,0,0]]},
{best:9,m:[[0,0,2],[1,1,0],[0,0,0]]}
];

//////////////////////////////////////////////////
// ÂàùÂßãÂåñ
//////////////////////////////////////////////////

function init(){
  function rebuildCatFromGrid(){

catPath=[];

for(let y=0;y<grid.length;y++){
for(let x=0;x<grid[0].length;x++){

if(grid[y][x]===2){
catPath.push({x,y});
grid[y][x]=3;
}
}
}

if(catPath.length!==1){
alert("‚ö† ÂøÖÈ†à‰∏îÂè™ËÉΩÊúâ‰∏ÄÈöªË≤ìËµ∑ÈªûÔºÅ");
editorMode=true;
return false;
}

history=[];
moveCount=0;
return true;
}
grid=LEVELS[level-1].m.map(r=>[...r]);
catPath=[];
history=[];
moveCount=0;

for(let y=0;y<grid.length;y++)
for(let x=0;x<grid[0].length;x++)
if(grid[y][x]==2){
catPath=[{x,y}];
grid[y][x]=3;
}

canvas.width=grid[0].length*TILE;
canvas.height=grid.length*TILE;

document.getElementById("lvl").innerText=level;
draw();
}

//////////////////////////////////////////////////
// Áï´Èù¢
//////////////////////////////////////////////////

function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);

grid.forEach((row,y)=>{
row.forEach((cell,x)=>{
ctx.strokeStyle="#eee";
ctx.strokeRect(x*TILE,y*TILE,TILE,TILE);

if(cell==1){
ctx.font="40px Arial";
ctx.fillText("üì¶",x*TILE+15,y*TILE+50);
}
});
});

catPath.forEach((p,i)=>{
if(i<catPath.length-1){
ctx.font="25px Arial";
ctx.fillText("üêæ",p.x*TILE+20,p.y*TILE+50);
}
});

let head=catPath.at(-1);
ctx.font="48px Arial";
ctx.fillText("üê±",head.x*TILE+10,head.y*TILE+55);
}

//////////////////////////////////////////////////
// Undo
//////////////////////////////////////////////////

function save(){
history.push({
grid:grid.map(r=>[...r]),
path:catPath.map(p=>({...p})),
moves:moveCount
});
}

function undo(){
let h=history.pop();
if(!h)return;
grid=h.grid;
catPath=h.path;
moveCount=h.moves;
beep(220,.08);
draw();
}

//////////////////////////////////////////////////
// ÁßªÂãï
//////////////////////////////////////////////////

function move(dx,dy){

if(editorMode)return;

save();
moveCount++;
beep(500,.05);

let head=catPath.at(-1);

while(true){
let nx=head.x+dx;
let ny=head.y+dy;

if(grid[ny]?.[nx]!==0)break;

grid[ny][nx]=3;
catPath.push({x:nx,y:ny});
head={x:nx,y:ny};
}

draw();
checkWin();
}

//////////////////////////////////////////////////
// ÊòüÁ¥öÂà§ÂÆö
//////////////////////////////////////////////////

function calcStars(){
let best=LEVELS[level-1].best;
if(moveCount<=best) return "‚≠ê‚≠ê‚≠ê";
if(moveCount<=best+2) return "‚≠ê‚≠ê";
return "‚≠ê";
}

//////////////////////////////////////////////////
// ÂãùÂà©
//////////////////////////////////////////////////

function checkWin(){
if(grid.some(r=>r.includes(0)))return;

beep(900,.2);

document.getElementById("stars").innerText=calcStars();

setTimeout(()=>{
level++;
if(level>LEVELS.length){
alert("üê± Longcat PRO ÂÖ®Á†¥ÔºÅ");
level=1;
}
init();
},600);
}

//////////////////////////////////////////////////
// Á∑®ËºØÂô®Ê®°Âºè
//////////////////////////////////////////////////

canvas.addEventListener("click",e=>{
if(!editorMode)return;

const rect=canvas.getBoundingClientRect();
let x=Math.floor((e.clientX-rect.left)/TILE);
let y=Math.floor((e.clientY-rect.top)/TILE);

grid[y][x]=(grid[y][x]+1)%3;
draw();
});

function toggleEditor(){

editorMode=!editorMode;

if(editorMode){
alert("ÈÄ≤ÂÖ•Á∑®ËºØÂô®Ê®°Âºè");
return;
}

// ‚Üê Èõ¢ÈñãÁ∑®ËºØÂô®ÊôÇ‰øÆÂæ©Ë≥áÊñô
if(!rebuildCatFromGrid()) return;

draw();
alert("Â∑≤Â•óÁî®Êñ∞ÈóúÂç°");

}

//////////////////////////////////////////////////
// ÊâãÊ©üÊªëÂãï
//////////////////////////////////////////////////

let sx=0,sy=0;

canvas.addEventListener("touchstart",e=>{
sx=e.touches[0].clientX;
sy=e.touches[0].clientY;
});

canvas.addEventListener("touchend",e=>{
let dx=e.changedTouches[0].clientX-sx;
let dy=e.changedTouches[0].clientY-sy;

if(Math.abs(dx)>Math.abs(dy))
move(dx>0?1:-1,0);
else
move(0,dy>0?1:-1);
});

//////////////////////////////////////////////////
// ÈçµÁõ§
//////////////////////////////////////////////////

window.addEventListener("keydown",e=>{
if(e.key==="z"||e.key==="Z")undo();
if(e.key==="e"||e.key==="E")toggleEditor();

if(e.key==="ArrowUp")move(0,-1);
if(e.key==="ArrowDown")move(0,1);
if(e.key==="ArrowLeft")move(-1,0);
if(e.key==="ArrowRight")move(1,0);
});

init();
</script>
</body>
</html>
