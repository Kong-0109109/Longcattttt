<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qç‰ˆ Longcat: å†’éšªç‹</title>
    <style>
        body {
            display: flex; flex-direction: column; align-items: center;
            background-color: #f7f1e3; font-family: 'Microsoft JhengHei', sans-serif;
            transition: background-color 0.8s ease; margin: 0; padding: 20px;
        }
        .ui-panel {
            background: white; padding: 15px 30px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px;
        }
        h1 { color: #ff5252; margin: 0; }
        #game-container { position: relative; }
        canvas {
            background-color: #fff; border: 10px solid #fff;
            border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .stats { font-size: 18px; color: #333; margin: 5px 0; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button {
            padding: 10px 20px; border: none; border-radius: 12px;
            background: #33d9b2; color: white; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #218c74; }
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="login-modal" class="login-overlay">
    <div class="ui-panel">
        <h2>æ­¡è¿ä¾†åˆ°é•·é•·è²“ï¼</h2>
        <p>è«‹è¼¸å…¥ç©å®¶åç¨±ä»¥ç´€éŒ„é€²åº¦ï¼š</p>
        <input type="text" id="username-input" placeholder="ä½ çš„åå­—..." style="padding: 10px; width: 80%; border-radius: 5px; border: 1px solid #ddd;">
        <br><br>
        <button onclick="userLogin()">é–‹å§‹å†’éšª</button>
    </div>
</div>

<div class="ui-panel">
    <h1>ğŸ± <span id="display-name">Player</span> çš„é•·é•·è²“</h1>
    <div class="stats">ç¬¬ <span id="lvl-num">1</span> é—œ (æœ€é«˜ç´€éŒ„: <span id="record-num">1</span>)</div>
    <div id="skin-tag" style="font-size: 14px; color: #777;">è§£é–çš®è†šï¼šğŸ± æ©˜æ©˜</div>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<div class="btn-group">
    <button onclick="resetLevel()">é‡æ–°å˜—è©¦</button>
    <button onclick="logout()" style="background:#aaa;">æ›´æ›å¸³è™Ÿ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let currentUser = "";
    let currentLvl = 1;
    let grid = [];
    let catPath = [];
    let skin = "ğŸ±";
    const TILE_SIZE = 55;

    // åœ°åœ–è‰²å½©ä¸»é¡Œ
    const THEMES = [
        { bg: "#f7f1e3", grid: "#fff", wall: "ğŸ“¦" }, // è‰åŸ
        { bg: "#d1ccc0", grid: "#f1f2f6", wall: "ğŸ§±" }, // å·¥å» 
        { bg: "#ffb8b8", grid: "#fff0f0", wall: "ğŸŒ¸" }, // æ«»èŠ±
        { bg: "#706fd3", grid: "#474787", wall: "ğŸ’" }  // åŸå ¡
    ];

    function userLogin() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        
        currentUser = name;
        // è®€å–æŒä¹…åŒ–æ•¸æ“š
        const savedData = JSON.parse(localStorage.getItem('longcat_data_' + name)) || { lvl: 1 };
        currentLvl = savedData.lvl;
        
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('display-name').innerText = name;
        initLevel();
    }

    function saveProgress() {
        localStorage.setItem('longcat_data_' + currentUser, JSON.stringify({ lvl: currentLvl }));
    }

    // è‡ªå‹•ç”Ÿæˆé—œå¡æ ¸å¿ƒç®—æ³•
    function generateLevel(lvl) {
        const size = Math.min(4 + Math.floor(lvl / 5), 9); // æ¯5é—œè®Šå¤§ä¸€é»
        let newMap = Array.from({ length: size }, () => Array(size).fill(0));
        
        // éš¨æ©Ÿéšœç¤™ç‰© (éš¨è‘—ç­‰ç´šå¢åŠ é›£åº¦)
        const wallCount = Math.floor(size * size * 0.15);
        for(let i=0; i<wallCount; i++) {
            let rx = Math.floor(Math.random()*size);
            let ry = Math.floor(Math.random()*size);
            newMap[ry][rx] = 1;
        }

        // éš¨æ©Ÿèµ·é»
        let startX = Math.floor(Math.random()*size);
        let startY = Math.floor(Math.random()*size);
        newMap[startY][startX] = 2;

        return newMap;
    }

    function initLevel() {
        const mapData = generateLevel(currentLvl);
        grid = mapData.map(row => [...row]);
        catPath = [];

        // è¨­ç½®åœ°åœ–è½‰æ›èˆ‡çš®è†š
        const themeIndex = Math.floor((currentLvl-1) / 5) % THEMES.length;
        document.body.style.backgroundColor = THEMES[themeIndex].bg;
        if(currentLvl >= 5) { skin = "ğŸ¦Š"; document.getElementById('skin-tag').innerText = "è§£é–çš®è†šï¼šğŸ¦Š å°ç‹"; }
        if(currentLvl >= 10) { skin = "ğŸ¯"; document.getElementById('skin-tag').innerText = "è§£é–çš®è†šï¼šğŸ¯ è™è™"; }
        if(currentLvl >= 15) { skin = "ğŸ²"; document.getElementById('skin-tag').innerText = "è§£é–çš®è†šï¼šğŸ² é¾é¾"; }

        canvas.width = grid[0].length * TILE_SIZE;
        canvas.height = grid.length * TILE_SIZE;

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                if(grid[r][c] === 2) catPath.push({x: c, y: r});
            }
        }
        
        document.getElementById('lvl-num').innerText = currentLvl;
        document.getElementById('record-num').innerText = currentLvl;
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const theme = THEMES[Math.floor((currentLvl-1) / 5) % THEMES.length];

        for(let r=0; r<grid.length; r++) {
            for(let c=0; c<grid[0].length; c++) {
                ctx.strokeStyle = "#ddd";
                ctx.strokeRect(c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                if(grid[r][c] === 1) {
                    ctx.font = "35px Arial";
                    ctx.fillText(theme.wall, c*TILE_SIZE + 10, r*TILE_SIZE + 42);
                }
            }
        }

        catPath.forEach((pos, i) => {
            if(i > 0) {
                ctx.font = "25px Arial";
                ctx.fillText("ğŸ¾", pos.x*TILE_SIZE + 15, pos.y*TILE_SIZE + 38);
            }
        });

        const head = catPath[catPath.length-1];
        ctx.font = "40px Arial";
        ctx.fillText(skin, head.x*TILE_SIZE + 8, head.y*TILE_SIZE + 45);
    }

    function move(dx, dy) {
        let head = catPath[catPath.length-1];
        let moved = false;
        while(true) {
            let nX = head.x + dx, nY = head.y + dy;
            if(nY>=0 && nY<grid.length && nX>=0 && nX<grid[0].length && grid[nY][nX] === 0) {
                grid[nY][nX] = 3;
                catPath.push({x: nX, y: nY});
                head = {x: nX, y: nY};
                moved = true;
            } else { break; }
        }
        if(moved) { draw(); checkWin(); }
    }

    function checkWin() {
        if(!grid.some(row => row.includes(0))) {
            setTimeout(() => {
                alert("å¤ªæ£’äº† " + currentUser + "ï¼é€²å…¥ä¸‹ä¸€é—œï¼");
                currentLvl++;
                saveProgress();
                initLevel();
            }, 200);
        }
    }

    function resetLevel() { initLevel(); }
    function logout() { location.reload(); }

    window.addEventListener('keydown', (e) => {
        if(e.key === "ArrowUp") move(0, -1);
        if(e.key === "ArrowDown") move(0, 1);
        if(e.key === "ArrowLeft") move(-1, 0);
        if(e.key === "ArrowRight") move(1, 0);
    });
</script>

</body>
</html>
